name: Build Docker image (no push)

inputs:
  dockerfile:
    required: true
    description: "Dockerfile"
  docker-context:
    required: false
    default: '.'
    description: "Docker context"
  build-args:
    required: false
    description: "Build Args"

outputs:
  artifact-name:
    value: ${{ steps.prep.outputs.name }}
    description: "artifact name"
  artifact-sha256:
    value: ${{ steps.upload.outputs.sha256 }}
    description: "artifact digest"

runs:
  using: composite
  steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build OCI layout
      id: build
      uses: docker/build-push-action@v6
      with:
        context: ${{ inputs.docker-context }}
        file: ${{ inputs.dockerfile }}
        push: false
        outputs: type=oci,dest=${{ github.workspace }}/oci-layout
        build-args: ${{ inputs.build-args }}

    - name: Make unique name
      id: prep
      shell: bash
      run: |
        echo "name=oci-$(openssl rand -hex 12)" >> "$GITHUB_OUTPUT"

    - name: Secure upload folder
      id: upload
      uses: slsa-framework/slsa-github-generator/actions/delegator/secure-upload-folder@v2.1.0
      with:
        name: ${{ steps.prep.outputs.name }}
        path: ${{ github.workspace }}/oci-layout
